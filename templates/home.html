{% extends 'base.html' %}
{% block title %}SMArt SureScripts Connector{% endblock %}
{% block body_params %}onload="load()"{% endblock %}
{% block content %}

<h2 align="center">SMArt SureScripts Connector</h2>

<p>  Setting up the connector is a two-step process: </p>

<ol>
<li>Connect to SMArt{% if smart_access_token %} &#x2713;<font size=-2>({{smart_access_token}})</font>{%else%}:

 <a href="{%url connector.views.indivo_start_auth%}">Go!</a>
{%endif%}
</li>
<li>Connect to SureScripts{% if smart_access_token and not hospital_access_token%}:
 <a href="{%url connector.views.hospital_start_auth%}" target="_new">Go!</a>
{%else%}{% if smart_access_token and hospital_access_token%}
&#x2713;  <font size=-2>({{hospital_access_token}})</font>
{%endif%}
{%endif%}

</li>
</ol>

{% if smart_access_token and hospital_access_token%}
<p>You're all connected -- your SureScripts <b>data will flow automatically</b> into SMArt.  </p>

<p>If you change your mind, you may
<a href="{%url connector.views.reset%}">Stop the Connector</a>.</p>
{%endif%}

{% if smart_access_token and not hospital_access_token%}
<script>
var load = function() {

window.addEventListener("message", receiveMessage, false);

function receiveMessage(event)
{
  var thisloc = location.protocol+"//"+location.host;
  if (event.origin !== thisloc)
    alert("Got message from wrong origin: " + thisloc + " vs. " + event.origin);
  
  if (event.data === "Auth Complete") {
     window.location.reload();
  }

}

};
</script>
{% endif %}

{% endblock %}
